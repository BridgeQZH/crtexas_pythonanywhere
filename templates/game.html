

<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>{{ '蓝国王' if color=='blue' else '红国王' }}的卡池</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
  <!-- 在所有内嵌脚本之前引入 -->
  <script src="{{ url_for('static', filename='js/cardmap.js') }}"></script>
  <h2>公共卡池</h2>
  <!-- ⬇︎ 用 data-id 存编号，JS 读取 -->
  <div id="public-grid" class="card-grid-4">
  {% for cid in public_pool %}
    <div class="card-wrapper" data-id="{{ cid }}">
      <img class="card"
           src="{{ url_for('static', filename='cards/' ~ cid ~ '.png') }}"
           alt="card {{ cid }}">
    </div>
  {% endfor %}
</div>

  <h2>私人卡池</h2>
  <div id="private-grid" class="card-grid-2">
  {% for cid in private_pool %}
    <div class="card-wrapper" data-id="{{ cid }}">
      <img class="card"
           src="{{ url_for('static', filename='cards/' ~ cid ~ '.png') }}"
           alt="card {{ cid }}">
    </div>
  {% endfor %}
</div>

  <!-- 塔楼单选： -->
  <h3>选择塔楼部队</h3>
  <form id="tower-form">
    <label><input type="radio" name="tower" value="159000002"> 刀塔</label>
    <label><input type="radio" name="tower" value="159000004"> 厨师塔</label>
    <label><input type="radio" name="tower" value="159000001"> 炮塔</label>
    <label><input type="radio" name="tower" value="159000000" checked> 公主塔</label>
  </form>

  <!-- 复制按钮 -->
  <button id="copy-btn" disabled>复制该卡组</button>

  <p><a href="{{ url_for('main.index') }}">← 重新开始</a></p>
  <footer class="footer-note">© BridgeQZH  bilibili</footer>

  <!-- ====== 内嵌脚本 ====== -->
  <script>
    const MAX_DECK = 8;
    let selectedIds = [];                             // 保持选牌顺序

    // 绑定点击
    document.querySelectorAll('.card-wrapper').forEach(wrap => {
      wrap.addEventListener('click', () => toggleSelect(wrap));
    });

    const btn = document.getElementById('copy-btn');
    const towerForm = document.getElementById('tower-form');

    function toggleSelect(wrap) {
      const id = wrap.dataset.id;
      const idx = selectedIds.indexOf(id);

      if (idx !== -1) {            // 已选 → 取消
        selectedIds.splice(idx, 1);
        wrap.classList.remove('selected');
        wrap.removeAttribute('data-num');
      } else {                     // 未选 → 尝试加入
        if (selectedIds.length >= MAX_DECK) return;
        selectedIds.push(id);
        wrap.classList.add('selected');
        wrap.setAttribute('data-num', selectedIds.length);
      }
      renumberBadges();
      btn.disabled = selectedIds.length !== MAX_DECK;
    }

    // 重新编号徽章
    function renumberBadges() {
      selectedIds.forEach((id, i) => {
        const w = document.querySelector(`.card-wrapper[data-id='${id}']`);
        if (w) w.setAttribute('data-num', i + 1);
      });
    }

    // 点击复制
    btn.addEventListener('click', () => {
      if (selectedIds.length !== MAX_DECK) return;
      const deckParam = selectedIds.map(encode).join(';');
      const tt = towerForm.tower.value;
      const url = `https://link.clashroyale.com/en?clashroyale://copyDeck?deck=${deckParam}&tt=${tt}&l=Royals`;
      window.open(url, '_blank', 'noopener');
    });
</script>
</body>
</html>
